<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>COE MIDIS – Resumen de emergencias Reportadas</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- html2pdf (html2canvas + jsPDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- XLSX para leer Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root {
    --card-border: #e0e0e0;
    --azul-midis: #0d6efd;
    --rojo-activa: #d32f2f;
    --naranja-proceso: #ff9800;
    --gris-cerrado: #9e9e9e;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    background: #f5f6fa;
    color: #222;
  }

  header {
    background: #f2f6ff;
    border-bottom: 1px solid #d6e0ff;
    padding: 12px 18px;
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
  }

  #logo {
    width: 8.53cm;
    height: 2.32cm;
    object-fit: contain;
  }

  .header-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .header-topline {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    flex-wrap: wrap;
  }

  h1 {
    margin: 0;
    font-size: 20px;
  }

  .subtitle {
    font-size: 13px;
    color: #555;
  }

  .tools {
    margin-left: auto;
    display: flex;
    flex-direction: column;
    gap: 6px;
    align-items: flex-end;
  }

  .btn {
    appearance: none;
    border-radius: 8px;
    border: 1px solid var(--azul-midis);
    padding: 6px 12px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    background: var(--azul-midis);
    color: #fff;
  }

  .btn-outline {
    background: #fff;
    color: var(--azul-midis);
  }

  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .tab-bar {
    display: flex;
    gap: 4px;
    font-size: 12px;
  }

  .tab {
    border-radius: 999px;
    border: 1px solid #c0c7ff;
    padding: 4px 10px;
    background: #ffffff;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    color: #445;
  }

  .tab.active {
    background: var(--azul-midis);
    color: #fff;
    border-color: var(--azul-midis);
  }

  .date-filters {
    display: flex;
    gap: 6px;
    align-items: center;
    flex-wrap: wrap;
    font-size: 12px;
  }

  .date-filters label {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .date-filters input[type="date"] {
    padding: 3px 4px;
    border-radius: 6px;
    border: 1px solid #c0c7ff;
    font-size: 12px;
  }

  main {
    padding: 12px 18px 18px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .kpi-row {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(210px,1fr));
    gap: 12px;
    margin-bottom: 12px;
  }

  .kpi-card {
    background: #ffffff;
    border-radius: 10px;
    border: 1px solid var(--card-border);
    padding: 10px 12px;
  }

  .kpi-label {
    font-size: 12px;
    color: #444;
    margin-bottom: 4px;
  }

  .kpi-value {
    font-size: 22px;
    font-weight: 700;
  }

  .kpi-pill {
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 999px;
    background: #eef3ff;
    color: #333;
  }

  .layout-grid {
    display: grid;
    grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
    gap: 14px;
    margin-bottom: 14px;
  }

  .card {
    background: #ffffff;
    border-radius: 10px;
    border: 1px solid var(--card-border);
    padding: 10px 12px;
  }

  .card-title {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .card-title span.badge {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 999px;
    background: #eef3ff;
  }

  .card-subtitle {
    font-size: 13px;
    font-weight: 600;
    margin: 10px 0 4px;
  }

  #chartTipos {
    width: 100%;
    max-height: 260px;
  }

  #chartImpacto,
  #chartFallecidos {
    width: 100%;
    max-height: 260px;
  }

  #map {
    width: 100%;
    height: 340px;
    border-radius: 8px;
    border: 1px solid #d0d7ff;
    position: relative;
    overflow: hidden;
  }

  .map-placeholder {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px;
    text-align: center;
    font-size: 12px;
    font-weight: 600;
    color: #444;
    background: rgba(255, 255, 255, 0.7);
    pointer-events: none;
  }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
    gap: 8px;
    font-size: 12px;
  }

  .summary-block {
    padding: 6px 8px;
    border-radius: 8px;
    background: #f7f7f7;
    border: 1px solid #e1e1e1;
  }

  .summary-block strong {
    display: block;
    margin-bottom: 4px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }

  th, td {
    border: 1px solid #eee;
    padding: 5px 6px;
    vertical-align: top;
  }

  th {
    background: #fafafa;
    text-align: left;
  }

  tbody tr:hover {
    outline: 2px solid #000;
    outline-offset: -2px;
  }

  tr.row-activa {
    background: #ffe5e5;
  }

  tr.row-proceso {
    background: #fff3da;
  }

  .pill-estado {
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 600;
    display: inline-block;
  }

  .pill-activa {
    background: #ffebee;
    color: #b71c1c;
  }

  .pill-proceso {
    background: #fff3e0;
    color: #e65100;
  }

  .pill-cerrado {
    background: #eceff1;
    color: #37474f;
  }

  #errorBox {
    display: none;
    margin-bottom: 10px;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid #f00;
    background: #ffecec;
    color: #900;
    font-size: 12px;
  }

  footer {
    margin-top: 10px;
    font-size: 11px;
    color: #666;
    text-align: right;
  }

  /* Toggle interno solo para "Distribución por tipo de evento" */
  .chart-toggle {
    display: inline-flex;
    flex-wrap: wrap;
    gap: 4px;
    margin: 4px 0 4px;
  }

  .chart-toggle-btn {
    border-radius: 999px;
    border: 1px solid #c0c7ff;
    background: #ffffff;
    padding: 3px 8px;
    font-size: 11px;
    cursor: pointer;
  }

  .chart-toggle-btn.active {
    background: var(--azul-midis);
    color: #ffffff;
    border-color: var(--azul-midis);
  }

  @media (max-width: 900px) {
    .layout-grid {
      grid-template-columns: 1fr;
    }
    #map {
      height: 280px;
    }
  }
</style>
</head>
<body>
<div id="export-root">
  <header>
    <img id="logo" src="coe_midis.jpg" alt="COE MIDIS" />
    <div class="header-main">
      <div class="header-topline">
        <div>
          <h1 id="titulo">COE MIDIS – Resumen de emergencias Reportadas</h1>
        </div>
        <div class="tools">
          <div class="tab-bar">
            <button class="tab active" data-mode="7d">Últimos 7 días</button>
            <button class="tab" data-mode="30d">Últimos 30 días</button>
            <button class="tab" data-mode="custom">Rango personalizado</button>
          </div>
          <div class="date-filters">
            <label>Desde:
              <input type="date" id="fecha-desde" />
            </label>
            <label>Hasta:
              <input type="date" id="fecha-hasta" />
            </label>
            <button id="btn-aplicar-fechas" class="btn btn-outline">Aplicar</button>
          </div>
        </div>
      </div>
      <div class="subtitle">
        Información consolidada a partir de los reportes diarios registrados en <strong>emergencias.xlsx</strong>.
      </div>
    </div>
  </header>

  <main>
    <div id="errorBox"></div>

    <!-- BLOQUE DIARIO ARRIBA -->
    <section class="kpi-row" id="bloque-diario">
      <div class="kpi-card">
        <div class="kpi-label" id="lbl-dia-corte">Emergencias del día</div>
        <div class="kpi-value" id="dia-total">0</div>
        <div class="kpi-pill">Total de eventos del día</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Activas (día)</div>
        <div class="kpi-value" id="dia-activas">0</div>
        <div class="kpi-pill">Requieren seguimiento inmediato hoy</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">En proceso (día)</div>
        <div class="kpi-value" id="dia-proceso">0</div>
        <div class="kpi-pill">Acciones en curso hoy</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Cerradas (día)</div>
        <div class="kpi-value" id="dia-cerradas">0</div>
        <div class="kpi-pill">Atenciones concluidas hoy</div>
      </div>
    </section>

    <section class="card">
      <div class="card-title">
        Detalle de emergencias del día de corte
      </div>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Ubicación</th>
            <th>Fecha evento / Tipo</th><!-- CAMBIADO -->
            <th>Resumen general</th>
            <th>Afectación MIDIS</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="tabla-dia-detalle">
        </tbody>
      </table>
    </section>

    <!-- KPIs DEL RANGO -->
    <section class="kpi-row">
      <div class="kpi-card">
        <div class="kpi-label">Total de eventos en el rango</div>
        <div class="kpi-value" id="kpi-total">0</div>
        <div class="kpi-pill" id="kpi-total-detalle">—</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Emergencias activas</div>
        <div class="kpi-value" id="kpi-activas">0</div>
        <div class="kpi-pill">Eventos que requieren seguimiento inmediato</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Eventos en proceso</div>
        <div class="kpi-value" id="kpi-proceso">0</div>
        <div class="kpi-pill">Con acciones en curso</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Eventos cerrados</div>
        <div class="kpi-value" id="kpi-cerrados">0</div>
        <div class="kpi-pill">Atenciones concluidas en el rango</div>
      </div>
    </section>

    <!-- Gráfico + Mapa -->
    <section class="layout-grid">
      <div class="card">
        <div class="card-title">
          Distribución por tipo de evento
          <span class="badge" id="badge-eventos">0 tipos</span>
        </div>
        <!-- NUEVO: pestañas internas -->
        <div class="chart-toggle">
          <button class="chart-toggle-btn active" data-tipos-mode="evento">Por evento</button>
          <button class="chart-toggle-btn" data-tipos-mode="region">Por Región</button>
        </div>
        <canvas id="chartTipos"></canvas>
      </div>

      <div class="card">
        <div class="card-title">
          Mapa de emergencias en el rango
          <span class="badge">COE MIDIS / EMSS</span>
        </div>
        <div id="map">
          <div class="map-placeholder">
            Mapa interactivo visible en la versión web.<br />
            En el PDF se mostrará el recuadro, pero no la imagen de los mosaicos del mapa
            por restricciones del navegador.
          </div>
        </div>
      </div>
    </section>

    <!-- Resumen MIDIS + Histogramas -->
    <section class="card">
      <div class="card-title">
        Impacto en la población usuaria y servicios del sector MIDIS
      </div>
      <div class="summary-grid">
        <div class="summary-block">
          <strong>Personas usuarias afectadas</strong>
          <span id="sum-usuarios">—</span>
        </div>
        <div class="summary-block">
          <strong>Servicios del sector afectados</strong>
          <span id="sum-servicios">—</span>
        </div>
        <div class="summary-block">
          <strong>Usuarios afectados por servicio</strong>
          <span id="sum-usua-serv">—</span>
        </div>
        <div class="summary-block">
          <strong>Personas usuarias fallecidas</strong>
          <span id="sum-fallecidos">—</span>
        </div>
        <div class="summary-block">
          <strong>Notas operativas</strong>
          <span id="sum-notas">
            El COE MIDIS mantiene monitoreo permanente y coordinación con los Programas Nacionales para asegurar la continuidad de los servicios.
          </span>
        </div>
      </div>

      <div class="card-subtitle">
        Distribución de afectación por programa (usuarios y servicios)
      </div>
      <canvas id="chartImpacto"></canvas>

      <div class="card-subtitle">
        Personas usuarias fallecidas por programa
      </div>
      <canvas id="chartFallecidos"></canvas>
    </section>

    <!-- Tabla de eventos relevantes -->
    <section class="card">
      <div class="card-title">
        Eventos relevantes (top por impacto MIDIS en el rango)
      </div>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Ubicación</th>
            <th>Fecha evento / Tipo</th>
            <th>Usuarios fallecidos</th>
            <th>Usuarios afectados</th>
            <th>Servicios afectados</th>
            <th>Usuarios afectados por servicio</th>
            <th>Programas afectados</th>
            <th>Acciones</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="tabla-eventos">
        </tbody>
      </table>
    </section>

    <footer>
      COE MIDIS – Resumen generado automáticamente desde <code>emergencias.xlsx</code>.
    </footer>
  </main>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* === VARIABLES GLOBALES === */
let datosBase = null;      // { meta, eventosAll, detalleAll, detallePorEvento }
let globalMinDate = null;
let globalMaxDate = null;
let currentMode = '7d';    // '7d' | '30d' | 'custom'

/* NUEVO: modo del gráfico de tipos y caché de eventos del rango */
let chartTiposMode = 'evento';   // 'evento' | 'region'
let eventosRangoCache = [];

/* === Utilidades de fecha/Excel === */

/* Conversión robusta de serial Excel */
function excelSerialToJSDate(n) {
  const days = Number(n) - 25569;
  const ms = days * 86400000;
  return new Date(ms + 12 * 60 * 60 * 1000); // +12h para evitar desfase
}

function excelSerialToDateString(n) {
  const d = excelSerialToJSDate(n);
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  return dd + '/' + mm + '/' + yyyy;
}

// Interpreta fecha_evento y fecha_registro
function parseFechaValue(v) {
  if (v === null || v === undefined || v === '') return null;

  if (typeof v === 'number') {
    return excelSerialToJSDate(v);
  }

  if (typeof v === 'string') {
    const s = v.trim();

    // YYYY-MM-DD o YYYY/MM/DD
    if (/^\d{4}[-/]\d{2}[-/]\d{2}$/.test(s)) {
      const [y, m, d] = s.split(/[-/]/).map(Number);
      return new Date(y, m - 1, d);
    }

    // DD/MM/YYYY o DD-MM-YYYY
    if (/^\d{1,2}[-/]\d{1,2}[-/]\d{4}$/.test(s)) {
      const [d, m, y] = s.split(/[-/]/).map(Number);
      return new Date(y, m - 1, d);
    }
  }

  return null;
}

function formatFechaCorta(d) {
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
}

function toISODate(d) {
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  return `${yyyy}-${mm}-${dd}`;
}

/* === Mapa Leaflet === */
const map = L.map('map').setView([-12.2, -75.2], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '&copy; OpenStreetMap',
  crossOrigin: true
}).addTo(map);

window.addEventListener('load', () => {
  setTimeout(() => map.invalidateSize(), 300);
});
window.addEventListener('resize', () => {
  setTimeout(() => map.invalidateSize(), 300);
});

const markersById = {};
const colorActiva = '#d32f2f';
const colorProceso = '#ff9800';
const colorCerrado = '#757575';

function showErr(msg) {
  const box = document.getElementById('errorBox');
  box.style.display = 'block';
  box.textContent = msg;
}

function clearMarkers() {
  for (const id in markersById) {
    if (markersById[id]) {
      map.removeLayer(markersById[id]);
      delete markersById[id];
    }
  }
}

/* === Charts === */
let chartTipos = null;
let chartImpacto = null;
let chartFallecidos = null;

/* NUEVO: función para actualizar datos del gráfico según modo */
function updateChartTiposFromEventos(eventosFiltrados) {
  eventosRangoCache = eventosFiltrados.slice();
  const data = {};

  if (chartTiposMode === 'evento') {
    eventosFiltrados.forEach(e => {
      const key = e.tipo || 'Sin clasificar';
      data[key] = (data[key] || 0) + 1;
    });
  } else if (chartTiposMode === 'region') {
    eventosFiltrados.forEach(e => {
      const key = e.departamento || 'Sin departamento';
      data[key] = (data[key] || 0) + 1;
    });
  }

  renderChartTipos(data);
}

function renderChartTipos(dataPorTipo) {
  const ctx = document.getElementById('chartTipos').getContext('2d');
  if (chartTipos) chartTipos.destroy();

  const labels = Object.keys(dataPorTipo);
  const valores = labels.map(l => dataPorTipo[l]);

  let badgeText;
  let datasetLabel;

  if (chartTiposMode === 'evento') {
    badgeText = labels.length + ' tipos';
    datasetLabel = 'Eventos por tipo';
  } else {
    badgeText = labels.length + ' regiones';
    datasetLabel = 'Eventos por región';
  }

  document.getElementById('badge-eventos').textContent = badgeText;

  if (!labels.length) return;

  chartTipos = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: datasetLabel,
        data: valores,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { ticks: { font: { size: 11 } } },
        y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } }
      },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: ctx => `${ctx.parsed.y} evento(s)` } }
      }
    }
  });
}

function renderChartImpacto(impactoPorPrograma) {
  const canvas = document.getElementById('chartImpacto');
  const ctx = canvas.getContext('2d');
  if (chartImpacto) chartImpacto.destroy();

  const labels = Object.keys(impactoPorPrograma);
  if (!labels.length) return;

  const dataUsuarios = labels.map(l => impactoPorPrograma[l].usuarios);
  const dataServicios = labels.map(l => impactoPorPrograma[l].servicios);
  const dataUsuaServ = labels.map(l => impactoPorPrograma[l].usua_afe_serv || 0);

  chartImpacto = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Personas usuarias afectadas', data: dataUsuarios, borderWidth: 1 },
        { label: 'Servicios afectados', data: dataServicios, borderWidth: 1 },
        { label: 'Usuarios afectados por servicio', data: dataUsuaServ, borderWidth: 1 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { ticks: { font: { size: 10 } } },
        y: { beginAtZero: true, ticks: { precision: 0 } }
      },
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toLocaleString('es-PE')}`
          }
        }
      }
    }
  });
}

function renderChartFallecidos(fallecidosPorPrograma) {
  const canvas = document.getElementById('chartFallecidos');
  const ctx = canvas.getContext('2d');
  if (chartFallecidos) chartFallecidos.destroy();

  const labels = Object.keys(fallecidosPorPrograma);
  if (!labels.length) return;

  const dataF = labels.map(l => fallecidosPorPrograma[l]);

  chartFallecidos = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Personas usuarias fallecidas',
          data: dataF,
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { ticks: { font: { size: 10 } } },
        y: { beginAtZero: true, ticks: { precision: 0 } }
      },
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toLocaleString('es-PE')}`
          }
        }
      }
    }
  });
}

/* === Carga de Excel === */
async function cargarDesdeExcel() {
  const resp = await fetch('emergencias.xlsx?_=' + Date.now());
  if (!resp.ok) throw new Error('No se encontró emergencias.xlsx');
  const wb = XLSX.read(await resp.arrayBuffer(), { type: 'array' });

  const metaSheet = wb.Sheets['meta'];
  let impactoClave = '';
  if (metaSheet) {
    const metaRows = XLSX.utils.sheet_to_json(metaSheet, { header: 1 });
    const hdrMeta = (metaRows[0] || []).map(String);
    const rowMeta = metaRows[1] || [];
    const idxMeta = n => hdrMeta.indexOf(n);
    impactoClave = String(rowMeta[idxMeta('impacto_clave')] || '');
  }

  const evSheet = wb.Sheets['events'];
  if (!evSheet) throw new Error('Hoja "events" no existe');

  const rawEvents = XLSX.utils.sheet_to_json(evSheet, { defval: '' });

  const eventosAll = rawEvents.map(e => {
    const fechaEvtJs = parseFechaValue(e.fecha_evento);
    const fechaEvtStr = (typeof e.fecha_evento === 'number')
      ? excelSerialToDateString(e.fecha_evento)
      : (e.fecha_evento || '');

    let fechaRegJs = null;
    let fechaRegStr = '';
    if (e.fecha_registro !== undefined && e.fecha_registro !== null && e.fecha_registro !== '') {
      fechaRegJs = parseFechaValue(e.fecha_registro);
      fechaRegStr = (typeof e.fecha_registro === 'number')
        ? excelSerialToDateString(e.fecha_registro)
        : (e.fecha_registro || '');
    } else {
      fechaRegJs = fechaEvtJs;
      fechaRegStr = fechaEvtStr;
    }

    return {
      id_evento: e.id_evento,
      departamento: e.departamento,
      provincia: e.provincia,
      distrito: e.distrito,
      fechaEvtJs,
      fechaEvtStr,
      fechaRegJs,
      fechaRegStr,
      tipo: e.tipo,
      estado: (e.estado || '').trim(),
      lat: Number(e.lat),
      lon: Number(e.lon),
      resumen_general: e.resumen_general,
      acciones: e.acciones
    };
  }).filter(e => e.fechaEvtJs instanceof Date && !isNaN(e.fechaEvtJs.getTime()));

  const detSheet = wb.Sheets['impacto_programa'];
  if (!detSheet) throw new Error('Hoja "impacto_programa" no existe');

  const rawDetalle = XLSX.utils.sheet_to_json(detSheet, { defval: '' });

  const detalleAll = rawDetalle.map(p => ({
    id_evento: p.id_evento,
    programa: (p.programa || '').toString().trim(),
    usuarios_afectados: Number(p.usuarios_afectados || 0),
    servicios_afectados: Number(p.servicios_afectados || 0),
    usua_afe_serv: Number(p.usua_afe_serv || 0),
    usuarios_fallecidos: Number(p.usuarios_fallecidos || 0)
  }));

  const detallePorEvento = {};
  detalleAll.forEach(p => {
    if (!detallePorEvento[p.id_evento]) {
      detallePorEvento[p.id_evento] = [];
    }
    detallePorEvento[p.id_evento].push(p);
  });

  return {
    meta: { impactoClave },
    eventosAll,
    detalleAll,
    detallePorEvento
  };
}

/* === Construcción del dashboard === */
function construirDashboard(meta, eventosFiltrados, fechaDesde, fechaHasta) {
  const total = eventosFiltrados.length;
  const activas = eventosFiltrados.filter(e => e.estado === 'Activa').length;
  const proceso = eventosFiltrados.filter(e => e.estado === 'En proceso').length;
  const cerrados = eventosFiltrados.filter(e => e.estado === 'Cerrado').length;

  document.getElementById('kpi-total').textContent = total;
  document.getElementById('kpi-activas').textContent = activas;
  document.getElementById('kpi-proceso').textContent = proceso;
  document.getElementById('kpi-cerrados').textContent = cerrados;

  document.getElementById('kpi-total-detalle').textContent =
    `Eventos registrados entre ${formatFechaCorta(fechaDesde)} y ${formatFechaCorta(fechaHasta)}`;

  /* NUEVO: delega al modo seleccionado (evento / región) */
  updateChartTiposFromEventos(eventosFiltrados);

  const idsEnRango = new Set(eventosFiltrados.map(e => e.id_evento));
  const detalleFiltrado = datosBase.detalleAll.filter(p => idsEnRango.has(p.id_evento));

  const sumUsuarios = detalleFiltrado.reduce((acc, p) => acc + (p.usuarios_afectados || 0), 0);
  const sumServicios = detalleFiltrado.reduce((acc, p) => acc + (p.servicios_afectados || 0), 0);
  const sumUsuaServ = detalleFiltrado.reduce((acc, p) => acc + (p.usua_afe_serv || 0), 0);
  const sumFallecidos = detalleFiltrado.reduce((acc, p) => acc + (p.usuarios_fallecidos || 0), 0);

  document.getElementById('sum-usuarios').textContent =
    sumUsuarios > 0 ? sumUsuarios.toLocaleString('es-PE') + ' personas usuarias' : 'Sin registros numéricos en el rango';

  document.getElementById('sum-servicios').textContent =
    sumServicios > 0 ? sumServicios.toLocaleString('es-PE') + ' servicios del sector' : 'Sin servicios cuantificados en el rango';

  document.getElementById('sum-usua-serv').textContent =
    sumUsuaServ > 0 ? sumUsuaServ.toLocaleString('es-PE') + ' usuarios afectados por servicio' : 'Sin registros numéricos en el rango';

  document.getElementById('sum-fallecidos').textContent =
    sumFallecidos > 0 ? sumFallecidos.toLocaleString('es-PE') + ' personas usuarias fallecidas' : 'Sin registros numéricos en el rango';

  const impactoPorPrograma = {};
  const fallecidosPorPrograma = {};
  detalleFiltrado.forEach(p => {
    const prog = p.programa && p.programa.trim();
    if (!prog) return;

    if (!impactoPorPrograma[prog]) {
      impactoPorPrograma[prog] = { usuarios: 0, servicios: 0, usua_afe_serv: 0 };
    }
    impactoPorPrograma[prog].usuarios += p.usuarios_afectados || 0;
    impactoPorPrograma[prog].servicios += p.servicios_afectados || 0;
    impactoPorPrograma[prog].usua_afe_serv += p.usua_afe_serv || 0;

    if (!fallecidosPorPrograma[prog]) fallecidosPorPrograma[prog] = 0;
    fallecidosPorPrograma[prog] += p.usuarios_fallecidos || 0;
  });

  renderChartImpacto(impactoPorPrograma);
  renderChartFallecidos(fallecidosPorPrograma);

  clearMarkers();
  const coordsValidos = eventosFiltrados.filter(e => !isNaN(e.lat) && !isNaN(e.lon));
  coordsValidos.forEach(e => {
    const estado = (e.estado || '').toLowerCase();
    let stroke = colorCerrado;
    if (estado === 'activa') stroke = colorActiva;
    else if (estado === 'en proceso') stroke = colorProceso;

    const m = L.circleMarker([e.lat, e.lon], {
      radius: 7,
      color: stroke,
      weight: 1.5,
      fillColor: stroke,
      fillOpacity: 0.95
    }).addTo(map);

    m.bindPopup(
      `<b>${e.distrito}, ${e.provincia} (${e.departamento})</b><br>` +
      `${e.fechaEvtStr} – ${e.tipo}<br>` +
      `<i>Estado:</i> ${e.estado || '—'}<br>` +
      `<i>Resumen:</i> ${e.resumen_general || '—'}`
    );

    markersById[e.id_evento] = m;
  });

  if (coordsValidos.length > 0) {
    try {
      const bounds = L.latLngBounds(coordsValidos.map(e => [e.lat, e.lon]));
      map.fitBounds(bounds, { padding: [10, 10] });
    } catch {}
  }

  const eventosConProgramas = eventosFiltrados.map(e => {
    const det = datosBase.detallePorEvento[e.id_evento] || [];
    if (!det.length) return null;

    const usuarios_afectados = det.reduce((a, p) => a + (p.usuarios_afectados || 0), 0);
    const servicios_afectados = det.reduce((a, p) => a + (p.servicios_afectados || 0), 0);
    const usua_afe_serv = det.reduce((a, p) => a + (p.usua_afe_serv || 0), 0);
    const usuarios_fallecidos = det.reduce((a, p) => a + (p.usuarios_fallecidos || 0), 0);
    const listaProgramas = [...new Set(det.map(p => p.programa).filter(Boolean))].join(', ');

    return {
      evento: e,
      usuarios_afectados,
      servicios_afectados,
      usua_afe_serv,
      usuarios_fallecidos,
      programas_texto: listaProgramas || '—'
    };
  }).filter(Boolean);

  const eventosOrdenados = [...eventosConProgramas].sort((a, b) => {
    const ua = a.usuarios_afectados || 0;
    const ub = b.usuarios_afectados || 0;
    if (ub !== ua) return ub - ua;
    const sa = a.servicios_afectados || 0;
    const sb = b.servicios_afectados || 0;
    if (sb !== sa) return sb - sa;
    return (b.evento.fechaEvtJs - a.evento.fechaEvtJs);
  });

  const tbody = document.getElementById('tabla-eventos');
  tbody.innerHTML = '';
  eventosOrdenados.forEach((r, i) => {
    const e = r.evento;
    const tr = document.createElement('tr');
    const estado = (e.estado || '').trim();
    if (estado === 'Activa') tr.classList.add('row-activa');
    else if (estado === 'En proceso') tr.classList.add('row-proceso');

    tr.innerHTML =
      `<td>${i+1}</td>` +
      `<td>${e.distrito}, ${e.provincia} (${e.departamento})</td>` +
      `<td>${e.fechaEvtStr}<br><small>${e.tipo || 'Sin clasificar'}</small></td>` +
      `<td>${(r.usuarios_fallecidos || 0).toLocaleString('es-PE')}</td>` +
      `<td>${(r.usuarios_afectados || 0).toLocaleString('es-PE')}</td>` +
      `<td>${(r.servicios_afectados || 0).toLocaleString('es-PE')}</td>` +
      `<td>${(r.usua_afe_serv || 0).toLocaleString('es-PE')}</td>` +
      `<td>${r.programas_texto}</td>` +
      `<td>${e.acciones || '—'}</td>` +
      `<td>${renderEstadoPill(estado)}</td>`;

    tbody.appendChild(tr);
  });

  /* === RESUMEN DIARIO DEL DÍA (fecha_registro) === */
  const hoy = new Date();
  const hoyNorm = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());

  const eventosDelDia = datosBase.eventosAll.filter(e => {
    const baseDate = (e.fechaRegJs instanceof Date && !isNaN(e.fechaRegJs.getTime()))
      ? e.fechaRegJs
      : e.fechaEvtJs;

    if (!(baseDate instanceof Date) || isNaN(baseDate.getTime())) return false;

    const d = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
    return d.getTime() === hoyNorm.getTime();
  });

  const totalDia = eventosDelDia.length;
  const activasDia = eventosDelDia.filter(e => e.estado === 'Activa').length;
  const procesoDia = eventosDelDia.filter(e => e.estado === 'En proceso').length;
  const cerradasDia = eventosDelDia.filter(e => e.estado === 'Cerrado').length;

  document.getElementById('lbl-dia-corte').textContent =
    `Emergencias del día (${formatFechaCorta(hoyNorm)})`;

  document.getElementById('dia-total').textContent = totalDia;
  document.getElementById('dia-activas').textContent = activasDia;
  document.getElementById('dia-proceso').textContent = procesoDia;
  document.getElementById('dia-cerradas').textContent = cerradasDia;

  const tbodyDia = document.getElementById('tabla-dia-detalle');
  tbodyDia.innerHTML = '';

  eventosDelDia.forEach((e, idx) => {
    const tr = document.createElement('tr');
    const estado = (e.estado || '').trim();
    if (estado === 'Activa') tr.classList.add('row-activa');
    else if (estado === 'En proceso') tr.classList.add('row-proceso');

    const detEv = datosBase.detallePorEvento[e.id_evento] || [];
    const tieneAfectacion = detEv.some(p =>
      (p.usuarios_afectados || 0) > 0 ||
      (p.servicios_afectados || 0) > 0 ||
      (p.usua_afe_serv || 0) > 0 ||
      (p.usuarios_fallecidos || 0) > 0
    );

    tr.innerHTML =
      `<td>${idx + 1}</td>` +
      `<td>${e.departamento}, ${e.provincia}, ${e.distrito}</td>` +
      `<td>${e.fechaEvtStr || e.fechaRegStr || ''}<br><small>${e.tipo || 'Sin clasificar'}</small></td>` +  <!-- CAMBIADO -->
      `<td>${e.resumen_general || '—'}</td>` +
      `<td>${tieneAfectacion ? 'Sí' : 'No'}</td>` +
      `<td>${renderEstadoPill(estado)}</td>`;

    tbodyDia.appendChild(tr);
  });
}

function renderEstadoPill(estado) {
  const s = (estado || '').toLowerCase();
  if (s === 'activa') {
    return `<span class="pill-estado pill-activa">Activa</span>`;
  }
  if (s === 'en proceso') {
    return `<span class="pill-estado pill-proceso">En proceso</span>`;
  }
  return `<span class="pill-estado pill-cerrado">${estado || 'Cerrado'}</span>`;
}

/* === FILTROS DE FECHA Y PESTAÑAS === */
function setInputsRange(desde, hasta) {
  const inputDesde = document.getElementById('fecha-desde');
  const inputHasta = document.getElementById('fecha-hasta');
  inputDesde.value = toISODate(desde);
  inputHasta.value = toISODate(hasta);
}

function inicializarFiltrosFecha() {
  const inputDesde = document.getElementById('fecha-desde');
  const inputHasta = document.getElementById('fecha-hasta');
  const eventos = datosBase.eventosAll;

  if (!eventos.length) return;

  globalMinDate = eventos[0].fechaEvtJs;
  globalMaxDate = eventos[0].fechaEvtJs;
  eventos.forEach(e => {
    if (e.fechaEvtJs < globalMinDate) globalMinDate = e.fechaEvtJs;
    if (e.fechaEvtJs > globalMaxDate) globalMaxDate = e.fechaEvtJs;
  });

  const hoy = new Date();
  const hoyOnly = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
  if (globalMaxDate < hoyOnly) {
    globalMaxDate = hoyOnly;
  }

  inputDesde.min = toISODate(globalMinDate);
  inputHasta.min = toISODate(globalMinDate);
  inputDesde.max = toISODate(globalMaxDate);
  inputHasta.max = toISODate(globalMaxDate);

  aplicarModo('7d');
}

function aplicarModo(mode) {
  currentMode = mode;

  document.querySelectorAll('.tab').forEach(tab => {
    if (tab.dataset.mode === mode) tab.classList.add('active');
    else tab.classList.remove('active');
  });

  const inputDesde = document.getElementById('fecha-desde');
  const inputHasta = document.getElementById('fecha-hasta');

  if (!globalMinDate || !globalMaxDate) return;

  if (mode === 'custom') {
    inputDesde.disabled = false;
    inputHasta.disabled = false;

    if (!inputDesde.value || !inputHasta.value) {
      let fechaHasta = new Date(globalMaxDate);
      let fechaDesde = new Date(fechaHasta);
      fechaDesde.setDate(fechaDesde.getDate() - 6);
      if (fechaDesde < globalMinDate) fechaDesde = new Date(globalMinDate);
      setInputsRange(fechaDesde, fechaHasta);
    }
    aplicarRangoActual();
  } else {
    inputDesde.disabled = true;
    inputHasta.disabled = true;

    let fechaHasta = new Date(globalMaxDate);
    let fechaDesde = new Date(fechaHasta);

    if (mode === '7d') {
      fechaDesde.setDate(fechaDesde.getDate() - 6);
    } else if (mode === '30d') {
      fechaDesde.setDate(fechaDesde.getDate() - 29);
    }

    if (fechaDesde < globalMinDate) fechaDesde = new Date(globalMinDate);

    setInputsRange(fechaDesde, fechaHasta);

    const eventos = datosBase.eventosAll.filter(e => {
      const d = new Date(e.fechaEvtJs.getFullYear(), e.fechaEvtJs.getMonth(), e.fechaEvtJs.getDate());
      return d >= fechaDesde && d <= fechaHasta;
    });

    construirDashboard(datosBase.meta, eventos, fechaDesde, fechaHasta);
  }
}

function aplicarRangoActual() {
  const inputDesde = document.getElementById('fecha-desde');
  const inputHasta = document.getElementById('fecha-hasta');

  if (!inputDesde.value || !inputHasta.value) return;

  const [y1,m1,d1] = inputDesde.value.split('-').map(Number);
  const [y2,m2,d2] = inputHasta.value.split('-').map(Number);

  let fechaDesde = new Date(y1, m1-1, d1);
  let fechaHasta = new Date(y2, m2-1, d2);

  if (fechaHasta < fechaDesde) {
    const tmp = fechaDesde;
    fechaDesde = fechaHasta;
    fechaHasta = tmp;
  }

  const eventos = datosBase.eventosAll.filter(e => {
    const d = new Date(e.fechaEvtJs.getFullYear(), e.fechaEvtJs.getMonth(), e.fechaEvtJs.getDate());
    return d >= fechaDesde && d <= fechaHasta;
  });

  construirDashboard(datosBase.meta, eventos, fechaDesde, fechaHasta);
}

/* Eventos de UI */
document.getElementById('btn-aplicar-fechas').addEventListener('click', () => {
  if (currentMode !== 'custom') {
    aplicarModo('custom');
  } else {
    aplicarRangoActual();
  }
});

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const mode = tab.dataset.mode;
    aplicarModo(mode);
  });
});

/* NUEVO: listeners para pestañas "Por evento" / "Por Región" */
document.querySelectorAll('.chart-toggle-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const mode = btn.dataset.tiposMode;
    if (!mode || mode === chartTiposMode) return;
    chartTiposMode = mode;

    document.querySelectorAll('.chart-toggle-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    if (eventosRangoCache && eventosRangoCache.length) {
      updateChartTiposFromEventos(eventosRangoCache);
    }
  });
});

/* === Inicio === */
(async () => {
  try {
    datosBase = await cargarDesdeExcel();
    inicializarFiltrosFecha();
  } catch (ex) {
    showErr('Error al cargar datos: ' + ex.message);
  }
})();
</script>
</body>
</html>
